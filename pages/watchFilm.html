<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>watch</title>
    <link rel="stylesheet" href="/assets/css/watchFilm.css" />
    <link rel="stylesheet" href="/assets/css/info.css" />
    <link rel="stylesheet" href="/assets/css/comment.css" />
  </head>

  <body>
    <section class="watch-film">
      <div class="film-display">
        <iframe
          width="900px"
          height="700px"
          src="https://ww1.vuaphimmoiz.net/jwplayer?source=https%3A%2F%2Fhls.streamcdn.xyz%2Fm3u8%2F1e438f10-8de2-57dd-87e3-103ccf3be6bb&id=&type=hls"
          frameborder="0">
        </iframe>
        <div class="function-buttons">
          <a href><i class="fa-solid fa-arrow-up-right-from-square"></i> Phóng
            to</a>
          <a href><i class="fa-solid fa-forward-step"></i> Chuyển tập</a>
          <a href><i class="fa-solid fa-circle-exclamation"></i> Báo cáo</a>
          <button class="add-to-library-button">
            <i class="fa-regular fa-square-plus"></i> thêm vào danh sách
          </button>
        </div>
        <div id="filmInfo"></div>
        <div class="film-comment">pull coment</div>
        <div class="page">
          <div class="content__body">
            <section>
              <ul class="comment__container"></ul>

            </section>
            <footer>
              <ul>
                <li>
                  <div class="section__comment">
                    <div>
                      <div class="section__avater">
                        <img src alt />
                      </div>
                      <div class="section__commentbox">
                        <textarea placeholder="Add comment"></textarea>
                      </div>
                      <div class="section__btn">
                        <button class="btn">Gửi</button>
                      </div>
                    </div>
                  </div>
                </li>
              </ul>
            </footer>
          </div>
        </div>
      </div>
    </section>
    <div class="model hidden">
      <div class="model__container">
        <div class="model__card">
          <div class="card__header">
            <h1>Xóa</h1>
          </div>
          <div class="card__body">
            <p>Bạn có muốn xóa?</p>
          </div>
          <div class="card__footer">
            <div class="btn__wrapper">
              <a class="btn card__btn_cancel">Không</a>
              <a class="btn card__btn_delete">Có</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script
    src="https://kit.fontawesome.com/40a8505060.js"
    crossorigin="anonymous"></script>
  <script src="/assets/js/comment.js" type="module"></script>
  <script>
    let films = JSON.parse(localStorage.getItem("films"));
    // Lấy thông tin từ URL
    let queryString = window.location.search;
    let urlParams = new URLSearchParams(queryString);
    let filmName = urlParams.get("film"); 
    let episodeNumber = urlParams.get("ep");
    var data = films.find((film) => film.name === filmName);

    // Lấy currentUser từ localStorage khi người dùng đăng nhập
    document.addEventListener("DOMContentLoaded", function () {
      // Lấy thông tin từ URL
      let queryString = window.location.search;
      let urlParams = new URLSearchParams(queryString);
      let filmName = urlParams.get("film");
      let episodeNumber = urlParams.get("ep");

      // Lấy dữ liệu người dùng hiện tại từ localStorage
      let currentUser = JSON.parse(localStorage.getItem("currentUser")) || {};

      // Thêm lịch sử xem
      function addToHistory(filmName, episodeNumber) {
        // Kiểm tra xem người dùng đã có lịch sử hay chưa
        if (!currentUser.history) {
          currentUser.history = [];
        }

        // Kiểm tra xem bộ phim và tập phim đã có trong lịch sử hay chưa
        let existingHistoryIndex = currentUser.history.findIndex(
          (entry) => entry.film === filmName && entry.episode === episodeNumber
        );

        if (existingHistoryIndex === -1) {
          // Nếu không tìm thấy, thêm mục mới vào cuối danh sách lịch sử
          currentUser.history.push({ film: filmName, episode: episodeNumber });
          // Cập nhật dữ liệu người dùng trong localStorage
          localStorage.setItem("currentUser", JSON.stringify(currentUser));
          let userList = JSON.parse(localStorage.getItem("userList"));
          const userIndex = userList.findIndex(
            (user) => user.username === currentUser.username
          );
          if (userIndex !== -1) {
            userList[userIndex] = currentUser;
            localStorage.setItem("userList", JSON.stringify(userList));
          }
        }
      }

      // Thực hiện hàm thêm vào lịch sử xem
      addToHistory(filmName, episodeNumber);
    });

    // Hiển thị thông tin trên trang
    let filmInfoDiv = document.getElementById("filmInfo");
    filmInfoDiv.innerHTML = `
          <h2>Watch ${filmName}, Episode ${episodeNumber}</h2>
          <p>${data.summary}</p>
      `;

    //render ep
    //render ep
    function renderInfoRight(data, episodeNumber) {
      const background = document.createElement("div");
      background.classList.add("background");

      const streamInfo = document.createElement("div");
      streamInfo.classList.add("stream-info");
      for (let i = 0; i < data.episode; i++) {
        let buttonEp = document.createElement("div");
        buttonEp.classList.add("stream-info");

        // Kiểm tra xem có phải là tập phim hiện tại không để thay đổi nền
        let temp = i + 1;
        if (temp === parseInt(episodeNumber)) {
          buttonEp.classList.add("episode-link");
        }

        buttonEp.innerHTML = `<a  .episode-link href="/pages/watchFilm.html?film=${
          data.name
        }&ep=${i + 1}">
                  <img src="${data.background_img}" alt="">
                  Episode ${i + 1}<i
                    class="fa-solid fa-circle-play fa-2xl"
                    style="color: #00ff40"
                  ></i>
                </a>`;
        background.appendChild(buttonEp);
      }
      background.appendChild(streamInfo);

      const infoRight = document.createElement("div");
      infoRight.classList.add("info-right");

      infoRight.appendChild(background);

      document.body.appendChild(infoRight);
    }
    // Sử dụng hàm renderInfoRight với tham số currentEpisode truyền vào
    renderInfoRight(data, episodeNumber);

    let addToLibraryButton = document.querySelector(".add-to-library-button");

    // Thêm sự kiện click vào nút "Add to Library"
    addToLibraryButton.addEventListener("click", function () {
      let currentUser = JSON.parse(localStorage.getItem("currentUser"));
      if (currentUser == "") {
        alert("Vui lòng đăng nhập để sử dụng chức năng này.");
        return;
      }
      // Lấy filmId từ thuộc tính data-film-id của nút "Add to Library"
      let filmId = parseInt(this.getAttribute("data-film-id"));
      let userList = JSON.parse(localStorage.getItem("userList"));
      let library = currentUser.library || [];
      for (let i = 0; i < library.length; i++) {
        if (library[i].name === films[filmId].name) {
          alert("Phim đã tồn tại trong thư viện của bạn.");
          return;
        }
      }
      let updatedLibrary = [...currentUser.library, films[filmId]];
      currentUser.library = updatedLibrary;
      localStorage.setItem("currentUser", JSON.stringify(currentUser));

      const userIndex = userList.findIndex(
        (user) => user.username === currentUser.username
      );
      if (userIndex !== -1) {
        userList[userIndex] = currentUser;
        localStorage.setItem("userList", JSON.stringify(userList));
      }
      alert("Phim đã được thêm vào thư viện của bạn.");
    });
  </script>

</html>
